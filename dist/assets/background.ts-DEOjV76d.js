import{S as r,D as l}from"./types-nBKLuWuN.js";function p(t){if(!t)throw new Error("Missing config");const e=t.oauthClientId||t.client_id||t.clientId||"",n=Array.isArray(t.oauthScopes)?t.oauthScopes:t.scopes,o=t.redirectExtensionId||t.redirect_extension_id||t.extension_id||void 0;return{oauthClientId:e,oauthScopes:n,redirectExtensionId:o}}async function E(){try{const t=await fetch("/config.json",{cache:"no-store"});if(t.ok)return p(await t.json())}catch{}try{const t=chrome.runtime.getURL("config.json"),e=await fetch(t,{cache:"no-store"});if(e.ok)return p(await e.json())}catch{}try{const t=chrome.runtime.getURL("config.example.json"),e=await fetch(t,{cache:"no-store"});if(e.ok)return p(await e.json())}catch{}throw new Error("Failed to load config.json")}function f(t){return new Promise(e=>chrome.storage.local.get(t,n=>e(n)))}function m(t){return new Promise(e=>chrome.storage.local.set(t,()=>e()))}async function w(t=!0){const{[r.accessToken]:e,[r.accessTokenExpiry]:n}=await f([r.accessToken,r.accessTokenExpiry]),o=Date.now();return e&&typeof n=="number"&&o<n-6e4?e:await _(t)}function k({clientId:t,scopes:e,redirectUri:n}){const o="https://accounts.google.com/o/oauth2/v2/auth",i=new URLSearchParams({client_id:t,response_type:"token",redirect_uri:n,scope:e.join(" "),include_granted_scopes:"true",prompt:"consent"});return`${o}?${i.toString()}`}async function _(t=!0){const e=await E();if(!e.oauthClientId)throw new Error("Missing oauthClientId in config.json");const o=`https://${e.redirectExtensionId||chrome.runtime.id}.chromiumapp.org/`,i=Array.isArray(e.oauthScopes)&&e.oauthScopes.length>0?e.oauthScopes:["https://www.googleapis.com/auth/spreadsheets"],c=k({clientId:e.oauthClientId,scopes:i,redirectUri:o}),u=await new Promise((S,y)=>{chrome.identity.launchWebAuthFlow({url:c,interactive:t},I=>{if(chrome.runtime.lastError){y(new Error(chrome.runtime.lastError.message));return}S(I)})}),a=new URL(u).hash.substring(1),h=new URLSearchParams(a),d=h.get("access_token"),s=Number(h.get("expires_in")||"3600");if(!d)throw new Error("Authorization failed: no access_token");const g=Date.now()+s*1e3;return await m({[r.accessToken]:d,[r.accessTokenExpiry]:g}),d}async function T(t){const{[r.sheetId]:e,[r.sheetName]:n}=await f([r.sheetId,r.sheetName]),o=n||l;if(!e)throw new Error("Sheet not configured. Set it in the extension options.");const i=await w(!0),c=`https://sheets.googleapis.com/v4/spreadsheets/${encodeURIComponent(e)}/values/${encodeURIComponent(o)}!A1:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS`,u={values:[t],majorDimension:"ROWS"},a=await fetch(c,{method:"POST",headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"},body:JSON.stringify(u)});if(!a.ok){const h=await a.text();throw new Error(`Sheets API error: ${a.status} ${h}`)}return await a.json()}function x(){const t=new Date,e=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${e}-${n}-${o}`}async function N(t){const e=t.company||"",n=t.location||"",o=t.title||"",i=t.workMode||"",c=t.applicationDate||x(),u=t.url||"",a=t.resume||"",d=[e,n,o,i,c,u,a,"Pending"];try{await T(d);const s={company:e,title:o,date:c};return await m({[r.lastSubmission]:s,[r.lastStatus]:{ok:!0,message:"Saved"}}),{ok:!0}}catch(s){return await m({[r.lastStatus]:{ok:!1,message:String((s==null?void 0:s.message)||s)}}),{ok:!1,error:String((s==null?void 0:s.message)||s)}}}chrome.runtime.onMessage.addListener((t,e,n)=>((async()=>{try{if(t&&t.type==="JOB_APPLICATION_SUBMITTED"){const o=await N(t.payload||{});n(o);return}if(t&&t.type==="JT_AUTHORIZE"){await w(!0),n({ok:!0});return}if(t&&t.type==="JT_GET_CONFIG"){const{[r.sheetId]:o,[r.sheetName]:i}=await f([r.sheetId,r.sheetName]);n({ok:!0,sheetId:o||"",sheetName:i||l});return}if(t&&t.type==="JT_SET_CONFIG"){const o={};typeof t.sheetId=="string"&&(o[r.sheetId]=t.sheetId.trim()),typeof t.sheetName=="string"&&(o[r.sheetName]=t.sheetName.trim()||l),await m(o),n({ok:!0});return}n({ok:!1,error:"Unknown message"})}catch(o){n({ok:!1,error:String((o==null?void 0:o.message)||o)})}})(),!0));
//# sourceMappingURL=background.ts-DEOjV76d.js.map
